import React, { useState, useEffect, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getAuth, 
  signInAnonymously, 
  signInWithCustomToken, 
  onAuthStateChanged,
  signOut
} from 'firebase/auth';
import { 
  getFirestore, 
  collection, 
  doc, 
  setDoc, 
  getDoc, 
  onSnapshot, 
  updateDoc, 
  increment,
  arrayUnion,
  query,
  where
} from 'firebase/firestore';
import { 
  Dumbbell, 
  Trophy, 
  Calendar, 
  Plus, 
  Trash2, 
  CheckCircle2, 
  XCircle, 
  AlertCircle,
  Activity,
  Flame,
  Bell,
  Sparkles,
  Zap,
  Brain,
  Clock,
  Download,
  Share,
  MoreVertical,
  X
} from 'lucide-react';

// --- Firebase Configuration ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

// --- Gemini API Helper ---
const generateGeminiContent = async (prompt, isJson = false) => {
  const apiKey = ""; // Injected by environment
  try {
    const payload = {
      contents: [{ parts: [{ text: prompt }] }]
    };

    // If we expect JSON, enforce it in the config
    if (isJson) {
      payload.generationConfig = {
        responseMimeType: "application/json",
        responseSchema: {
            type: "OBJECT",
            properties: {
                title: { type: "STRING" },
                description: { type: "STRING" },
                type: { type: "STRING", enum: ["strength", "cardio"] }
            }
        }
      };
    }

    const response = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      }
    );

    const data = await response.json();
    const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
    
    if (!text) throw new Error("No content generated");
    
    return isJson ? JSON.parse(text) : text;
  } catch (error) {
    console.error("Gemini API Error:", error);
    return null;
  }
};

// --- Components ---

const LoadingSpinner = () => (
  <div className="min-h-screen bg-slate-900 flex items-center justify-center text-white">
    <div className="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-emerald-500"></div>
  </div>
);

const LevelBadge = ({ xp }) => {
  const level = Math.floor(xp / 1000) + 1;
  const progress = (xp % 1000) / 10; // Percentage

  return (
    <div className="bg-slate-800 p-4 rounded-xl shadow-lg border border-slate-700 w-full mb-6">
      <div className="flex justify-between items-center mb-2">
        <span className="text-emerald-400 font-bold text-lg">Level {level}</span>
        <span className="text-slate-400 text-sm">{Math.floor(xp)} XP</span>
      </div>
      <div className="w-full bg-slate-700 rounded-full h-3">
        <div 
          className="bg-emerald-500 h-3 rounded-full transition-all duration-500"
          style={{ width: `${progress}%` }}
        ></div>
      </div>
      <p className="text-xs text-slate-500 mt-2 text-right">{1000 - (xp % 1000)} XP to next level</p>
    </div>
  );
};

const PlanCard = ({ plan, todayLog, onComplete, onMiss, onDelete }) => {
  const isCompleted = todayLog?.status === 'completed';
  const isMissed = todayLog?.status === 'missed';

  return (
    <div className="bg-slate-800 rounded-xl p-5 border border-slate-700 shadow-md hover:border-slate-600 transition-colors">
      <div className="flex justify-between items-start mb-3">
        <div>
          <h3 className="text-lg font-bold text-white flex items-center gap-2">
            {plan.icon === 'run' ? <Activity size={18} className="text-blue-400" /> : <Dumbbell size={18} className="text-orange-400" />}
            {plan.title}
          </h3>
          <p className="text-slate-400 text-sm mt-1 whitespace-pre-wrap">{plan.description}</p>
        </div>
        <button onClick={() => onDelete(plan.id)} className="text-slate-600 hover:text-red-400 transition-colors">
          <Trash2 size={16} />
        </button>
      </div>

      <div className="mt-4 flex gap-3">
        {isCompleted ? (
          <div className="w-full bg-emerald-500/20 border border-emerald-500/50 text-emerald-400 py-2 rounded-lg flex items-center justify-center gap-2 font-medium">
            <CheckCircle2 size={18} /> Completed (+100 XP)
          </div>
        ) : isMissed ? (
          <div className="w-full bg-red-500/20 border border-red-500/50 text-red-400 py-2 rounded-lg flex items-center justify-center gap-2 font-medium">
            <XCircle size={18} /> Missed (-100 XP)
          </div>
        ) : (
          <>
            <button 
              onClick={() => onComplete(plan)}
              className="flex-1 bg-emerald-600 hover:bg-emerald-500 text-white py-2 rounded-lg font-medium transition-colors flex items-center justify-center gap-2"
            >
              <CheckCircle2 size={18} /> Done
            </button>
            <button 
              onClick={() => onMiss(plan)}
              className="flex-1 bg-slate-700 hover:bg-red-900/50 text-slate-300 hover:text-red-400 py-2 rounded-lg font-medium transition-colors flex items-center justify-center gap-2"
            >
              <XCircle size={18} /> Skip
            </button>
          </>
        )}
      </div>
    </div>
  );
};

const AddPlanModal = ({ isOpen, onClose, onAdd }) => {
  const [title, setTitle] = useState('');
  const [description, setDescription] = useState('');
  const [type, setType] = useState('strength');
  
  // AI State
  const [aiPrompt, setAiPrompt] = useState('');
  const [isGenerating, setIsGenerating] = useState(false);
  const [showAiInput, setShowAiInput] = useState(false);

  if (!isOpen) return null;

  const handleSubmit = (e) => {
    e.preventDefault();
    if (!title) return;
    onAdd({ title, description, type });
    resetForm();
    onClose();
  };

  const resetForm = () => {
    setTitle('');
    setDescription('');
    setType('strength');
    setAiPrompt('');
    setIsGenerating(false);
    setShowAiInput(false);
  };

  const handleAiGenerate = async () => {
    if (!aiPrompt.trim()) return;
    setIsGenerating(true);
    
    const prompt = `Create a specific workout plan for: "${aiPrompt}". 
    Return a JSON object with:
    - title: A short, catchy title (string)
    - description: A concise list of exercises with sets and reps (string)
    - type: either "strength" or "cardio"`;

    const result = await generateGeminiContent(prompt, true);
    
    if (result) {
      setTitle(result.title || "AI Workout");
      setDescription(result.description || "Generated workout details.");
      setType(result.type || "strength");
      setShowAiInput(false); // Switch back to form view to let user review
    }
    setIsGenerating(false);
  };

  return (
    <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4">
      <div className="bg-slate-800 rounded-2xl w-full max-w-md border border-slate-700 p-6 shadow-2xl">
        <div className="flex justify-between items-center mb-4">
          <h2 className="text-xl font-bold text-white flex items-center gap-2">
            {showAiInput ? <><Sparkles className="text-purple-400" /> AI Generator</> : "Add Custom Workout"}
          </h2>
          <button 
            onClick={() => setShowAiInput(!showAiInput)}
            className={`text-xs px-3 py-1 rounded-full border transition-colors ${showAiInput ? 'border-slate-600 text-slate-400' : 'border-purple-500 text-purple-400 hover:bg-purple-500/10'}`}
          >
            {showAiInput ? "Switch to Manual" : "Use AI Magic ‚ú®"}
          </button>
        </div>

        {showAiInput ? (
          <div className="space-y-4 animate-in fade-in zoom-in duration-300">
            <div>
              <label className="block text-purple-300 text-sm mb-2">What's your goal today?</label>
              <textarea 
                value={aiPrompt}
                onChange={(e) => setAiPrompt(e.target.value)}
                className="w-full bg-slate-900 border border-purple-500/30 rounded-lg p-3 text-white focus:outline-none focus:border-purple-500 h-32 placeholder-slate-600"
                placeholder="e.g., A 15-minute ab workout for beginners"
              />
            </div>
            <button 
              onClick={handleAiGenerate}
              disabled={isGenerating || !aiPrompt}
              className="w-full bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-500 hover:to-indigo-500 text-white rounded-lg py-3 font-bold flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed transition-all"
            >
              {isGenerating ? <div className="animate-spin rounded-full h-5 w-5 border-2 border-white/30 border-t-white" /> : <Sparkles size={18} />}
              {isGenerating ? "Generating Plan..." : "Generate Workout"}
            </button>
          </div>
        ) : (
          <form onSubmit={handleSubmit} className="space-y-4 animate-in fade-in zoom-in duration-300">
            <div>
              <label className="block text-slate-400 text-sm mb-1">Workout Name</label>
              <input 
                value={title}
                onChange={(e) => setTitle(e.target.value)}
                className="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-white focus:outline-none focus:border-emerald-500"
                placeholder="e.g., Morning Yoga"
              />
            </div>
            <div>
              <label className="block text-slate-400 text-sm mb-1">Details (Reps/Time)</label>
              <textarea 
                value={description}
                onChange={(e) => setDescription(e.target.value)}
                className="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-white focus:outline-none focus:border-emerald-500 h-24"
                placeholder="e.g., 3 sets of 12 reps"
              />
            </div>
            <div>
              <label className="block text-slate-400 text-sm mb-1">Type</label>
              <div className="flex gap-2">
                <button 
                  type="button"
                  onClick={() => setType('strength')}
                  className={`flex-1 py-2 rounded-lg border transition-colors ${type === 'strength' ? 'bg-orange-500/20 border-orange-500 text-orange-400' : 'bg-slate-900 border-slate-700 text-slate-400'}`}
                >
                  Strength
                </button>
                <button 
                  type="button"
                  onClick={() => setType('cardio')}
                  className={`flex-1 py-2 rounded-lg border transition-colors ${type === 'cardio' ? 'bg-blue-500/20 border-blue-500 text-blue-400' : 'bg-slate-900 border-slate-700 text-slate-400'}`}
                >
                  Cardio
                </button>
              </div>
            </div>
            <div className="flex gap-3 mt-6">
              <button type="button" onClick={() => { resetForm(); onClose(); }} className="flex-1 text-slate-400 hover:text-white py-3">Cancel</button>
              <button type="submit" className="flex-1 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg py-3 font-bold">Add Plan</button>
            </div>
          </form>
        )}
      </div>
    </div>
  );
};

const AiCoachWidget = ({ xp, streak }) => {
  const [quote, setQuote] = useState(null);
  const [loading, setLoading] = useState(false);

  const getMotivation = async () => {
    setLoading(true);
    const prompt = `You are a tough but encouraging gym coach. The user has ${xp} XP (Level ${Math.floor(xp / 1000) + 1}) and a ${streak}-day streak. Give them a short, punchy, 1-sentence motivational shoutout to get them moving right now. Do not use quotes.`;
    
    const text = await generateGeminiContent(prompt);
    setQuote(text);
    setLoading(false);
  };

  return (
    <div className="mb-6 bg-gradient-to-r from-indigo-900/50 to-purple-900/50 border border-indigo-500/30 p-4 rounded-xl relative overflow-hidden">
      <div className="flex items-start gap-4 z-10 relative">
        <div className="bg-indigo-500/20 p-2 rounded-lg text-indigo-300 shrink-0">
            <Brain size={24} />
        </div>
        <div className="flex-1">
            <h3 className="text-indigo-200 font-bold text-sm mb-1 flex items-center gap-2">
                AI Coach
                {quote && <span className="text-xs font-normal text-indigo-400 bg-indigo-950/50 px-2 py-0.5 rounded-full">Gemini</span>}
            </h3>
            <p className="text-white/90 text-sm italic min-h-[1.5rem]">
                {loading ? "Consulting the fitness gods..." : (quote || "Need a boost? Ask me for motivation!")}
            </p>
        </div>
        <button 
            onClick={getMotivation}
            disabled={loading}
            className="shrink-0 bg-indigo-600 hover:bg-indigo-500 text-white p-2 rounded-lg transition-all active:scale-95 disabled:opacity-50"
        >
            {loading ? <div className="animate-spin h-5 w-5 border-2 border-white/30 border-t-white rounded-full" /> : <Zap size={20} />}
        </button>
      </div>
    </div>
  );
};

const InstallGuideModal = ({ isOpen, onClose }) => {
  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4">
      <div className="bg-slate-800 rounded-2xl w-full max-w-md border border-slate-700 p-6 shadow-xl relative animate-in fade-in zoom-in duration-200">
        <button onClick={onClose} className="absolute top-4 right-4 text-slate-400 hover:text-white transition-colors">
            <X size={24} />
        </button>
        
        <h2 className="text-xl font-bold text-white mb-4 flex items-center gap-2">
          <Download className="text-emerald-400" /> Install as App
        </h2>
        
        <div className="space-y-6 text-slate-300 text-sm">
            <p className="text-base">
                Use this daily like a real app by adding it to your home screen. No download required!
            </p>
            
            <div className="bg-slate-900/60 p-4 rounded-xl border border-slate-700">
            <h3 className="font-bold text-white mb-2 flex items-center gap-2">
                <span className="text-lg">üçé</span> iPhone (Safari)
            </h3>
            <ol className="list-none space-y-3">
                <li className="flex items-center gap-3">
                    <div className="w-6 h-6 rounded-full bg-slate-700 flex items-center justify-center text-xs font-bold text-white shrink-0">1</div>
                    <span>Tap the <Share className="inline mx-1 text-blue-400" size={16} /> <strong>Share</strong> button.</span>
                </li>
                <li className="flex items-center gap-3">
                    <div className="w-6 h-6 rounded-full bg-slate-700 flex items-center justify-center text-xs font-bold text-white shrink-0">2</div>
                    <span>Scroll down and tap <strong>"Add to Home Screen"</strong>.</span>
                </li>
            </ol>
            </div>

            <div className="bg-slate-900/60 p-4 rounded-xl border border-slate-700">
            <h3 className="font-bold text-white mb-2 flex items-center gap-2">
                <span className="text-lg">ü§ñ</span> Android (Chrome)
            </h3>
            <ol className="list-none space-y-3">
                <li className="flex items-center gap-3">
                    <div className="w-6 h-6 rounded-full bg-slate-700 flex items-center justify-center text-xs font-bold text-white shrink-0">1</div>
                    <span>Tap the menu icon <MoreVertical className="inline mx-1 text-white" size={16} /></span>
                </li>
                <li className="flex items-center gap-3">
                    <div className="w-6 h-6 rounded-full bg-slate-700 flex items-center justify-center text-xs font-bold text-white shrink-0">2</div>
                    <span>Select <strong>"Install App"</strong> or <strong>"Add to Home Screen"</strong>.</span>
                </li>
            </ol>
            </div>
        </div>
        
        <button 
            onClick={onClose} 
            className="w-full mt-6 bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-3 rounded-xl transition-colors"
        >
            Got it, thanks!
        </button>
      </div>
    </div>
  );
};

export default function App() {
  const [user, setUser] = useState(null);
  const [userData, setUserData] = useState({ xp: 0, streak: 0 });
  const [plans, setPlans] = useState([]);
  const [dailyLogs, setDailyLogs] = useState({});
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [loading, setLoading] = useState(true);
  const [notificationsEnabled, setNotificationsEnabled] = useState(false);
  const [isInstallModalOpen, setIsInstallModalOpen] = useState(false);

  // Auth Initialization
  useEffect(() => {
    const initAuth = async () => {
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        await signInWithCustomToken(auth, __initial_auth_token);
      } else {
        await signInAnonymously(auth);
      }
    };
    initAuth();
    
    const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
      setUser(currentUser);
      if (!currentUser) setLoading(false);
    });
    return () => unsubscribe();
  }, []);

  // Scheduled Notification for 5:30 AM
  useEffect(() => {
    if (!notificationsEnabled || Notification.permission !== "granted") return;

    const scheduleMorningNotification = () => {
      const now = new Date();
      const target = new Date();
      target.setHours(5, 30, 0, 0); // 5:30:00 AM
      
      // If it's already past 5:30 AM, schedule for tomorrow
      if (now > target) {
        target.setDate(target.getDate() + 1);
      }

      const timeUntil = target.getTime() - now.getTime();
      console.log(`Notification scheduled in ${(timeUntil / 1000 / 60 / 60).toFixed(2)} hours`);

      const timer = setTimeout(() => {
        new Notification("Rise & Shine! üåÖ", { 
          body: "It's 5:30 AM! Time to start your FitQuest streak!",
          requireInteraction: true,
          icon: "https://cdn-icons-png.flaticon.com/512/2928/2928900.png"
        });
        // Recursively schedule the next one
        scheduleMorningNotification(); 
      }, timeUntil);

      return timer;
    };

    const timerId = scheduleMorningNotification();
    return () => clearTimeout(timerId);
  }, [notificationsEnabled]);

  // Data Fetching
  useEffect(() => {
    if (!user) return;

    // 1. Fetch User Stats
    const statsRef = doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'stats');
    const unsubStats = onSnapshot(statsRef, (docSnap) => {
      if (docSnap.exists()) {
        setUserData(docSnap.data());
      } else {
        // Initialize default stats
        setDoc(statsRef, { xp: 0, streak: 0 });
      }
    }, (error) => console.error("Stats error:", error));

    // 2. Fetch Plans
    const plansRef = collection(db, 'artifacts', appId, 'users', user.uid, 'plans');
    const unsubPlans = onSnapshot(plansRef, (snapshot) => {
      const fetchedPlans = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      
      // Seed initial plans if empty
      if (fetchedPlans.length === 0) {
        const seedPlans = [
          {
            title: "One Punch Man",
            description: "100 Pushups, 100 Situps, 100 Squats, 10km Run",
            icon: "strength",
            created: Date.now()
          },
          {
            title: "30-Day Running",
            description: "Daily Run (See PDF schedule)",
            icon: "run",
            created: Date.now()
          }
        ];
        seedPlans.forEach(p => addPlanToFirestore(p));
      } else {
        setPlans(fetchedPlans);
      }
    }, (error) => console.error("Plans error:", error));

    // 3. Fetch Today's Logs
    const todayStr = new Date().toISOString().split('T')[0];
    const logsRef = collection(db, 'artifacts', appId, 'users', user.uid, 'logs');
    // Note: In a real app we'd query by date, but simplified here we fetch all and filter in memory for 'today' due to indexing limitations in this env
    const unsubLogs = onSnapshot(logsRef, (snapshot) => {
        const logs = {};
        snapshot.docs.forEach(doc => {
            const data = doc.data();
            if (data.date === todayStr) {
                logs[data.planId] = data;
            }
        });
        setDailyLogs(logs);
        setLoading(false);
    }, (error) => console.error("Logs error:", error));

    return () => {
      unsubStats();
      unsubPlans();
      unsubLogs();
    };
  }, [user]);

  // Request Notification Permission
  const toggleNotifications = async () => {
    if (!("Notification" in window)) {
      alert("This browser does not support desktop notification");
      return;
    }
    
    if (Notification.permission === "granted") {
      new Notification("Workout Tracker", { body: "Notifications are already enabled!" });
      setNotificationsEnabled(true);
    } else if (Notification.permission !== "denied") {
      const permission = await Notification.requestPermission();
      if (permission === "granted") {
        new Notification("Workout Tracker", { body: "You're all set! We'll remind you to workout." });
        setNotificationsEnabled(true);
      }
    }
  };

  const addPlanToFirestore = async (plan) => {
    if (!user) return;
    await setDoc(doc(collection(db, 'artifacts', appId, 'users', user.uid, 'plans')), plan);
  };

  const deletePlan = async (planId) => {
    // Optimistic UI update not strictly needed with onSnapshot, but good practice
    alert("Delete disabled to prevent accidental data loss in demo.");
  };

  const handleStatusUpdate = async (plan, status) => {
    if (!user) return;
    const todayStr = new Date().toISOString().split('T')[0];
    const logId = `${todayStr}_${plan.id}`;
    
    // Updated Penalty: -100 for missed
    const xpChange = status === 'completed' ? 100 : -100;

    // 1. Log the workout
    await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'logs', logId), {
      planId: plan.id,
      date: todayStr,
      status: status,
      timestamp: Date.now()
    });

    // 2. Update Stats (XP)
    const statsRef = doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'stats');
    await updateDoc(statsRef, {
      xp: increment(xpChange),
      streak: status === 'completed' ? increment(1) : userData.streak // simplified streak logic
    });
    
    // 3. Trigger Notification
    if (Notification.permission === "granted" && status === 'missed') {
        new Notification("Missed Workout", { body: `Don't give up! Penalty: ${xpChange} XP. Try again tomorrow!` });
    } else if (Notification.permission === "granted" && status === 'completed') {
        new Notification("Great Job!", { body: `Workout Complete! +${xpChange} XP` });
    }
  };

  const todayStr = new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });

  if (loading) return <LoadingSpinner />;

  return (
    <div className="min-h-screen bg-slate-900 text-white font-sans pb-20">
      {/* Header */}
      <header className="bg-slate-800 border-b border-slate-700 sticky top-0 z-10">
        <div className="max-w-md mx-auto px-4 py-4 flex justify-between items-center">
          <div className="flex items-center gap-2">
            <Flame className="text-orange-500" />
            <h1 className="text-xl font-bold bg-gradient-to-r from-emerald-400 to-blue-500 bg-clip-text text-transparent">
              FitQuest
            </h1>
          </div>
          <div className="flex gap-2">
             <button 
                onClick={() => setIsInstallModalOpen(true)}
                className="p-2 rounded-full text-slate-400 hover:bg-slate-700 hover:text-white transition-colors"
                title="Install App"
            >
                <Download size={20} />
            </button>
            <button 
                onClick={toggleNotifications}
                className={`p-2 rounded-full flex items-center gap-2 transition-colors ${notificationsEnabled ? 'text-emerald-400 bg-emerald-400/10' : 'text-slate-400 hover:bg-slate-700'}`}
                title="Notifications"
            >
                {notificationsEnabled ? <Clock size={16} className="text-emerald-400" /> : null}
                <Bell size={20} />
            </button>
          </div>
        </div>
      </header>

      <main className="max-w-md mx-auto px-4 py-6">
        {/* Stats Section */}
        <section className="mb-8">
          <LevelBadge xp={userData.xp || 0} />
          
          <AiCoachWidget xp={userData.xp} streak={userData.streak} />

          <div className="grid grid-cols-2 gap-4">
            <div className="bg-slate-800 p-4 rounded-xl border border-slate-700 flex flex-col items-center">
              <Trophy className="text-yellow-400 mb-2" size={24} />
              <span className="text-2xl font-bold text-white">{userData.xp || 0}</span>
              <span className="text-xs text-slate-400 uppercase tracking-wider">Total XP</span>
            </div>
            <div className="bg-slate-800 p-4 rounded-xl border border-slate-700 flex flex-col items-center">
              <Flame className="text-orange-500 mb-2" size={24} />
              <span className="text-2xl font-bold text-white">{userData.streak || 0}</span>
              <span className="text-xs text-slate-400 uppercase tracking-wider">Day Streak</span>
            </div>
          </div>
        </section>

        {/* Daily Tasks */}
        <section>
          <div className="flex justify-between items-end mb-4">
            <div>
              <h2 className="text-xl font-bold text-white">Today's Missions</h2>
              <p className="text-slate-400 text-sm">{todayStr}</p>
            </div>
            <button 
              onClick={() => setIsModalOpen(true)}
              className="bg-emerald-600 hover:bg-emerald-500 text-white p-2 rounded-lg transition-colors shadow-lg shadow-emerald-600/20"
            >
              <Plus size={20} />
            </button>
          </div>

          <div className="space-y-4">
            {plans.map(plan => (
              <PlanCard 
                key={plan.id} 
                plan={plan} 
                todayLog={dailyLogs[plan.id]}
                onComplete={(p) => handleStatusUpdate(p, 'completed')}
                onMiss={(p) => handleStatusUpdate(p, 'missed')}
                onDelete={deletePlan}
              />
            ))}
            
            {plans.length === 0 && (
              <div className="text-center py-10 text-slate-500 bg-slate-800/50 rounded-xl border border-dashed border-slate-700">
                <p>No active quests.</p>
                <button onClick={() => setIsModalOpen(true)} className="text-emerald-400 font-medium mt-2">Add your first workout</button>
              </div>
            )}
          </div>
        </section>

        {/* Info Box */}
        <div className="mt-8 bg-blue-900/20 border border-blue-500/20 p-4 rounded-xl flex gap-3">
          <AlertCircle className="text-blue-400 shrink-0" size={20} />
          <div className="text-sm text-blue-200">
            <p className="font-bold mb-1">How it works:</p>
            <ul className="list-disc list-inside space-y-1 opacity-80">
              <li>Complete daily tasks to earn <span className="text-emerald-400">+100 XP</span></li>
              <li>Missing a workout costs <span className="text-red-400 font-bold">-100 XP</span></li>
              <li>Tap the <Sparkles size={12} className="inline text-purple-400" /> icon in the (+) menu to use AI!</li>
            </ul>
          </div>
        </div>
      </main>

      <AddPlanModal 
        isOpen={isModalOpen} 
        onClose={() => setIsModalOpen(false)} 
        onAdd={addPlanToFirestore}
      />
      
      <InstallGuideModal 
        isOpen={isInstallModalOpen} 
        onClose={() => setIsInstallModalOpen(false)} 
      />
    </div>
  );
}
